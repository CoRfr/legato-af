#!/bin/sh

# Clean unpacked app files and restore backed up apps.
# Note: This script is called by update service provider(i.e. update daemon) to clean
# unnecessary unpacked app and restore any backed up app.

LEGATO_ROOT=/opt/legato
APPS_UNPACK_ROOT=$LEGATO_ROOT/appsUnpack
APPS_BACKUP_ROOT=$LEGATO_ROOT/appsBackup
APPS_TO_RESTORE=
exitCode=0

CleanAppUnpackDir()
# Clean everything in app unpack directory
{
    if [ -d "$APPS_UNPACK_ROOT" ]
    then
        echo "Clean residue files of apps unpack directory: $APPS_UNPACK_ROOT"
        rm -rf "$APPS_UNPACK_ROOT/"* > /dev/null 2>&1
    fi
}

RestoreBackedUpApps()
# Check if there is a something in appBackUp directory. If yes, restore them.
{
    if [ -d "$APPS_BACKUP_ROOT" ]
    then
        APPS_TO_RESTORE=`ls $APPS_BACKUP_ROOT`

        for APP_NAME in $APPS_TO_RESTORE
        do
            appTool restore $APP_NAME

            if [ $? -ne 0 ]
            then
                echo "FAILED to restore app: $appName"
                exitCode=1
            fi
        done
    fi
}

# Restore all backed up apps
RestoreBackedUpApps

# Clean any residue file in App Unpacking directory.
CleanAppUnpackDir

exit $exitCode