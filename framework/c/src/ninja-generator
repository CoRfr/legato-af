#!/bin/bash
# --------------------------------------------------------------------------------------------------
# Ninja build script generator for the liblegato build.
#
# Copyright (C) Sierra Wireless Inc.
# --------------------------------------------------------------------------------------------------

# Ensure all the required variables are set.
if [ -z "$LEGATO_ROOT" ]
then
    echo "**ERROR: LEGATO_ROOT is not set." 1>&2
    exit 1
fi

if [ -z "$LEGATO_TARGET" ]
then
    echo "**ERROR: LEGATO_TARGET is not set." 1>&2
    exit 1
fi

if [ -z "$TARGET_CC" ]
then
    echo "**ERROR: TARGET_CC is not set." 1>&2
    exit 1
fi

if [ "$LEGATO_TARGET" == "localhost" ]
then
    EMBEDDED_FLAGS=""
else
    EMBEDDED_FLAGS="-DLEGATO_EMBEDDED"
fi

if [ ! -z "$TARGET_SYSROOT" ]
then
    TARGET_CC="$TARGET_CC --sysroot=$TARGET_SYSROOT"
fi

# enable coverage.flags
if [ "$TEST_COVERAGE" == "1" ]
then
    NINJA_CFLAGS="--coverage"
    NINJA_LDFLAGS="--coverage"
fi

BUILD_DIR=$LEGATO_ROOT/build/$LEGATO_TARGET/framework

NINJA_SCRIPT=$BUILD_DIR/build.ninja
NINJA_SCRIPT_GENERATOR=$0

BIN_DIR=$BUILD_DIR/bin
LIB_DIR=$BUILD_DIR/lib
SRC_DIR=$LEGATO_ROOT/framework/c/src

# Turn a list of source file paths into a list of paths to the object (.o) files that they will
# be compiled into.
function ObjectsFromSources()
{
    for sourceFile in $*
    do
        printf "%s" "$BUILD_DIR/obj/`basename $sourceFile`.o "
    done
}

LIBLEGATO=$LIB_DIR/liblegato.so
LIBLEGATO_SOURCES=`ls $SRC_DIR/*.c`
LIBLEGATO_OBJECTS=`ObjectsFromSources $LIBLEGATO_SOURCES`

LEGATO_FRAMEWORK_NICE_LEVEL=-19
LE_RUNTIME_DIR=/tmp/legato
LE_SVCDIR_SERVER_SOCKET_NAME=$LE_RUNTIME_DIR/serviceDirectoryServer
LE_SVCDIR_CLIENT_SOCKET_NAME=$LE_RUNTIME_DIR/serviceDirectoryClient

cat > $NINJA_SCRIPT <<END-OF-HERE-DOC
# Build script for the Legato application framework's C runtime library (liblegato).

# == Auto-generated file.  DO NOT EDIT. ==
# == Generated by $0 ==

builddir = $BUILD_DIR

rule Compile
  description = Compiling liblegato source file
  depfile = \$out.d
  command = $TARGET_CC -MMD -MF \$out.d -c \$in -o \$out -Wall -fPIC -Werror \$flags \$
            -DLE_COMPONENT_NAME=framework \$
            -I$LEGATO_ROOT/framework/c/inc \$
            -DLE_SVCDIR_SERVER_SOCKET_NAME="\"$LE_SVCDIR_SERVER_SOCKET_NAME\"" \$
            -DLE_SVCDIR_CLIENT_SOCKET_NAME="\"$LE_SVCDIR_CLIENT_SOCKET_NAME\"" \$
            $EMBEDDED_FLAGS

rule Link
  description = Linking liblegato
  command = $TARGET_CC -shared -o \$out \$in -lpthread -lrt $NINJA_LDFLAGS

build $LIBLEGATO : Link $LIBLEGATO_OBJECTS

rule RegenNinjaScript
  description = Regenerating framework build script
  generator = 1
  command = export LEGATO_TARGET=$LEGATO_TARGET && \$
            export LEGATO_ROOT="$LEGATO_ROOT" && \$
            $NINJA_SCRIPT_GENERATOR

build $NINJA_SCRIPT : RegenNinjaScript | $NINJA_SCRIPT_GENERATOR

END-OF-HERE-DOC

for sourceFile in $LIBLEGATO_SOURCES
do
    echo "build `ObjectsFromSources $sourceFile` : Compile $sourceFile"
    echo "  flags = $NINJA_CFLAGS"
    echo

done >> $NINJA_SCRIPT
