/**
 * 
 * Copyright (C) Sierra Wireless, Inc. 2013.  All rights reserved. Use of this work is subject to license.
 *
 */

#include <stdio.h>
#include <unistd.h>
#include <ctype.h>
#include <string.h>
#include <time.h>

// Header files for CUnit
#include <CUnit/Console.h>
#include <CUnit/Basic.h>

#define PDU_MAX     256

#include "smspdu.h"

typedef struct {
    const char * dest;
    const char * text;
    struct {
        const size_t length;
        const uint8_t data[256];
    } pdu_7bits, pdu_8bits;
} PDUAssoc_t;

const PDUAssoc_t PDUAssocDb[] = {
        /* 0 */ {
                .dest = "+33661651866",
                .text = "Test sending message",
                .pdu_7bits = {
                        .length = 33,
                        .data = {
                                0x00, 0x11, 0x00, 0x0B, 0x91, 0x33, 0x66, 0x61, 0x15, 0x68,
                                0xF6, 0x00, 0x00, 0xAD, 0x14, 0xD4, 0xF2, 0x9C, 0x0E, 0x9A,
                                0x97, 0xDD, 0xE4, 0xB4, 0xFB, 0x0C, 0x6A, 0x97, 0xE7, 0xF3,
                                0xF0, 0xB9, 0x0C,
                        },
                },
                .pdu_8bits = {
                        .length = 35,
                        .data = {
                                0x00, 0x11, 0x00, 0x0B, 0x91, 0x33, 0x66, 0x61, 0x15, 0x68,
                                0xF6, 0x00, 0x04, 0xAD, 0x14, 0x54, 0x65, 0x73, 0x74, 0x20,
                                0x73, 0x65, 0x6E, 0x64, 0x69, 0x6E, 0x67, 0x20, 0x6D, 0x65,
                                0x73, 0x73, 0x61, 0x67, 0x65,
                        },
                },
        },
        /* 1 */ {
                .dest = "+33617190547",
                .text = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Morbi in commodo lectus, quis volutpat erat.",
                .pdu_7bits = {
                        .length = 104,
                        .data = {
                                0x00, 0x11, 0x00, 0x0B, 0x91, 0x33, 0x16, 0x17, 0x09, 0x45,
                                0xF7, 0x00, 0x00, 0xAD, 0x65, 0xCC, 0xB7, 0xBC, 0xDC, 0x06,
                                0xA5, 0xE1, 0xF3, 0x7A, 0x1B, 0x44, 0x7E, 0xB3, 0xDF, 0x72,
                                0xD0, 0x3C, 0x4D, 0x07, 0x85, 0xDB, 0x65, 0x3A, 0x0B, 0x34,
                                0x7E, 0xBB, 0xE7, 0xE5, 0x31, 0xBD, 0x4C, 0xAF, 0xCB, 0x41,
                                0x61, 0x72, 0x1A, 0x9E, 0x9E, 0x8F, 0xD3, 0xEE, 0x33, 0xA8,
                                0xCC, 0x4E, 0xD3, 0x5D, 0xA0, 0xE6, 0x5B, 0x2E, 0x4E, 0x83,
                                0xD2, 0x6E, 0xD0, 0xF8, 0xDD, 0x6E, 0xBF, 0xC9, 0x6F, 0x10,
                                0xBB, 0x3C, 0xA6, 0xD7, 0xE7, 0x2C, 0x50, 0xBC, 0x9E, 0x9E,
                                0x83, 0xEC, 0x6F, 0x76, 0x9D, 0x0E, 0x0F, 0xD3, 0x41, 0x65,
                                0x79, 0x98, 0xEE, 0x02,
                        }
                },
                .pdu_8bits = {
                        .length = 116,
                        .data = {
                                0x00, 0x11, 0x00, 0x0B, 0x91, 0x33, 0x16, 0x17, 0x09, 0x45,
                                0xF7, 0x00, 0x04, 0xAD, 0x65, 0x4C, 0x6F, 0x72, 0x65, 0x6D,
                                0x20, 0x69, 0x70, 0x73, 0x75, 0x6D, 0x20, 0x64, 0x6F, 0x6C,
                                0x6F, 0x72, 0x20, 0x73, 0x69, 0x74, 0x20, 0x61, 0x6D, 0x65,
                                0x74, 0x2C, 0x20, 0x63, 0x6F, 0x6E, 0x73, 0x65, 0x63, 0x74,
                                0x65, 0x74, 0x75, 0x72, 0x20, 0x61, 0x64, 0x69, 0x70, 0x69,
                                0x73, 0x63, 0x69, 0x6E, 0x67, 0x20, 0x65, 0x6C, 0x69, 0x74,
                                0x2E, 0x20, 0x4D, 0x6F, 0x72, 0x62, 0x69, 0x20, 0x69, 0x6E,
                                0x20, 0x63, 0x6F, 0x6D, 0x6D, 0x6F, 0x64, 0x6F, 0x20, 0x6C,
                                0x65, 0x63, 0x74, 0x75, 0x73, 0x2C, 0x20, 0x71, 0x75, 0x69,
                                0x73, 0x20, 0x76, 0x6F, 0x6C, 0x75, 0x74, 0x70, 0x61, 0x74,
                                0x20, 0x65, 0x72, 0x61, 0x74, 0x2E,
                        },
                },
        },
        /* 2 */ {
                .dest = "0617190547",
                .text = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Morbi in commodo lectus, quis volutpat erat.",
                .pdu_7bits = {
                        .length = 103,
                        .data = {
                                0x00, 0x11, 0x00, 0x0A, 0x81, 0x60, 0x71, 0x91, 0x50, 0x74,
                                0x00, 0x00, 0xAD, 0x65, 0xCC, 0xB7, 0xBC, 0xDC, 0x06, 0xA5,
                                0xE1, 0xF3, 0x7A, 0x1B, 0x44, 0x7E, 0xB3, 0xDF, 0x72, 0xD0,
                                0x3C, 0x4D, 0x07, 0x85, 0xDB, 0x65, 0x3A, 0x0B, 0x34, 0x7E,
                                0xBB, 0xE7, 0xE5, 0x31, 0xBD, 0x4C, 0xAF, 0xCB, 0x41, 0x61,
                                0x72, 0x1A, 0x9E, 0x9E, 0x8F, 0xD3, 0xEE, 0x33, 0xA8, 0xCC,
                                0x4E, 0xD3, 0x5D, 0xA0, 0xE6, 0x5B, 0x2E, 0x4E, 0x83, 0xD2,
                                0x6E, 0xD0, 0xF8, 0xDD, 0x6E, 0xBF, 0xC9, 0x6F, 0x10, 0xBB,
                                0x3C, 0xA6, 0xD7, 0xE7, 0x2C, 0x50, 0xBC, 0x9E, 0x9E, 0x83,
                                0xEC, 0x6F, 0x76, 0x9D, 0x0E, 0x0F, 0xD3, 0x41, 0x65, 0x79,
                                0x98, 0xEE, 0x02,
                        }
                },
                .pdu_8bits = {
                        .length = 115,
                        .data = {
                                0x00, 0x11, 0x00, 0x0A, 0x81, 0x60, 0x71, 0x91, 0x50, 0x74,
                                0x00, 0x04, 0xAD, 0x65, 0x4C, 0x6F, 0x72, 0x65, 0x6D, 0x20,
                                0x69, 0x70, 0x73, 0x75, 0x6D, 0x20, 0x64, 0x6F, 0x6C, 0x6F,
                                0x72, 0x20, 0x73, 0x69, 0x74, 0x20, 0x61, 0x6D, 0x65, 0x74,
                                0x2C, 0x20, 0x63, 0x6F, 0x6E, 0x73, 0x65, 0x63, 0x74, 0x65,
                                0x74, 0x75, 0x72, 0x20, 0x61, 0x64, 0x69, 0x70, 0x69, 0x73,
                                0x63, 0x69, 0x6E, 0x67, 0x20, 0x65, 0x6C, 0x69, 0x74, 0x2E,
                                0x20, 0x4D, 0x6F, 0x72, 0x62, 0x69, 0x20, 0x69, 0x6E, 0x20,
                                0x63, 0x6F, 0x6D, 0x6D, 0x6F, 0x64, 0x6F, 0x20, 0x6C, 0x65,
                                0x63, 0x74, 0x75, 0x73, 0x2C, 0x20, 0x71, 0x75, 0x69, 0x73,
                                0x20, 0x76, 0x6F, 0x6C, 0x75, 0x74, 0x70, 0x61, 0x74, 0x20,
                                0x65, 0x72, 0x61, 0x74, 0x2E,
                        },
                },
        },
};

/* The suite initialization function.
* Opens the temporary file used by the tests.
* Returns zero on success, non-zero otherwise.
*/
int init_suite(void)
{
    return 0;
}

/* The suite cleanup function.
* Closes the temporary file used by the tests.
* Returns zero on success, non-zero otherwise.
*/
int clean_suite(void)
{
    return 0;
}

void DumpPDU(const uint8_t * dataPtr, size_t length) {
    int i;
    const int columns = 32;

    for( i = 0; i < length+1; i++) {
        fprintf(stderr, "%02X", dataPtr[i]);
        if(i % columns == (columns-1) )
            fprintf(stderr, "\n");
    }
    fprintf(stderr, "\n");
}

void testEncodePdu()
{
    pa_sms_Pdu_t pdu;
    int i;
    
    for( i = 0; i < sizeof(PDUAssocDb)/sizeof(PDUAssoc_t); i++)
    {
        const PDUAssoc_t * assoc = &PDUAssocDb[i];

        /* Encode 8 bits */
        smspdu_Encode((const uint8_t*)assoc->text, strlen(assoc->text), assoc->dest, SMSPDU_8_BITS, &pdu);

        fprintf(stderr, "Source: (%zu)\n", assoc->pdu_8bits.length);
        DumpPDU(assoc->pdu_8bits.data, assoc->pdu_8bits.length);

        fprintf(stderr, "Encoded: (%u)\n", pdu.dataLen);
        DumpPDU(pdu.data, pdu.dataLen);

        /* Check */
        CU_ASSERT_EQUAL( pdu.dataLen, assoc->pdu_8bits.length );
        CU_ASSERT_EQUAL( memcmp(pdu.data, assoc->pdu_8bits.data, pdu.dataLen), 0);

        /* Encode 7 bits */
        smspdu_Encode((const uint8_t*)assoc->text, strlen(assoc->text), assoc->dest, SMSPDU_GSM_7_BITS, &pdu);

        fprintf(stderr, "Source: (%zu)\n", assoc->pdu_7bits.length);
        DumpPDU(assoc->pdu_7bits.data, assoc->pdu_7bits.length);

        fprintf(stderr, "Encoded: (%u)\n", pdu.dataLen);
        DumpPDU(pdu.data, pdu.dataLen);

        /* Check */
        CU_ASSERT_EQUAL( pdu.dataLen, assoc->pdu_7bits.length );
        CU_ASSERT_EQUAL( memcmp(pdu.data, assoc->pdu_7bits.data, pdu.dataLen), 0);
    }
}

LE_EVENT_INIT_HANDLER
{
    // Init the test case / test suite data structures
    
    CU_TestInfo testCases[] =
    {
            { "Test EncodePdu", testEncodePdu },
            CU_TEST_INFO_NULL,
    };
    
    CU_SuiteInfo suites[] =
    {
            { "PDU Convert tests", init_suite, clean_suite, testCases },
            CU_SUITE_INFO_NULL,
    };

    // Initialize the CUnit test registry and register the test suite
    if (CUE_SUCCESS != CU_initialize_registry())
        exit(CU_get_error());
    
    if ( CUE_SUCCESS != CU_register_suites(suites))
    {
        CU_cleanup_registry();
        exit(CU_get_error());
    }

    CU_basic_set_mode(CU_BRM_VERBOSE);
    CU_basic_run_tests();
 
    // Output summary of failures, if there were any
    if ( CU_get_number_of_failures() > 0 )
    {
        fprintf(stdout,"\n [START]List of Failure :\n");
        CU_basic_show_failures(CU_get_failure_list());
        fprintf(stdout,"\n [STOP]List of Failure\n");

        exit(EXIT_FAILURE);
    }

    exit(EXIT_SUCCESS);
}
